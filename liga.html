<script>
  const secciones = ['jugadores', 'partidos', 'tabla'];

  function mostrarSeccion(id) {
    secciones.forEach(s => document.getElementById(s).classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  function toggleMenu() {
    const menu = document.getElementById('menu');
    const isVisible = window.getComputedStyle(menu).display !== 'none';
    menu.style.display = isVisible ? 'none' : 'flex';
  }

  function toggleTheme() {
    const t = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', t);
    localStorage.setItem('theme', t);
  }

  let jugadores = [];
  let partidos = [];
  let resultados = [];

  function generarPartidos() {
    partidos = [];
    resultados = [];
    for (let i = 0; i < jugadores.length; i++) {
      for (let j = i + 1; j < jugadores.length; j++) {
        partidos.push([jugadores[i], jugadores[j]]);
        resultados.push([null, null]);
      }
    }
  }

  function agregarJugador() {
    const input = document.getElementById('nuevo-jugador');
    const nombre = input.value.trim();
    if (nombre && !jugadores.includes(nombre)) {
      jugadores.push(nombre);
      input.value = '';
      actualizarListaJugadores();
    }
  }

  function actualizarListaJugadores() {
    const lista = document.getElementById('lista-jugadores');
    lista.innerHTML = jugadores.map(j => `<li>${j}</li>`).join('');
  }

  function iniciarLiga() {
    if (jugadores.length < 2) return alert('Agrega al menos 2 jugadores');
    generarPartidos();
    mostrarPartidos();
    mostrarTabla();
    mostrarSeccion('partidos');
  }

  function mostrarPartidos() {
    const div = document.getElementById('lista-partidos');
    div.innerHTML = '';
    partidos.forEach(([a, b], i) => {
      const [g1, g2] = resultados[i];
      div.innerHTML += `
        <div>
          <span>${a} vs ${b}</span>
          <input type="number" placeholder="Goles ${a}" value="${g1 ?? ''}" onchange="guardarResultado(${i}, 0, this.value)">
          <input type="number" placeholder="Goles ${b}" value="${g2 ?? ''}" onchange="guardarResultado(${i}, 1, this.value)">
        </div>`;
    });
  }

  function guardarResultado(i, j, valor) {
    resultados[i][j] = parseInt(valor);
    mostrarTabla();
  }

  function mostrarTabla() {
    const tabla = {};

    resultados.forEach(([g1, g2], i) => {
      if (g1 == null || g2 == null) return;
      const [a, b] = partidos[i];

      tabla[a] = tabla[a] || { pts: 0, pj: 0, dg: 0, pg: 0, pe: 0, pp: 0 };
      tabla[b] = tabla[b] || { pts: 0, pj: 0, dg: 0, pg: 0, pe: 0, pp: 0 };

      tabla[a].pj++;
      tabla[b].pj++;

      tabla[a].dg += g1 - g2;
      tabla[b].dg += g2 - g1;

      if (g1 > g2) {
        tabla[a].pts += 3;
        tabla[a].pg++;
        tabla[b].pp++;
      } else if (g2 > g1) {
        tabla[b].pts += 3;
        tabla[b].pg++;
        tabla[a].pp++;
      } else {
        tabla[a].pts += 1;
        tabla[b].pts += 1;
        tabla[a].pe++;
        tabla[b].pe++;
      }
    });

    const div = document.getElementById('tabla-resultados');
    div.innerHTML = `<table>
      <tr>
        <th>Jugador</th>
        <th>Pts</th>
        <th>PJ</th>
        <th>DG</th>
        <th>PG</th>
        <th>PE</th>
        <th>PP</th>
      </tr>` +
      Object.entries(tabla)
        .sort((a, b) => b[1].pts - a[1].pts)
        .map(([nombre, stats]) => `
          <tr>
            <td>${nombre}</td>
            <td>${stats.pts}</td>
            <td>${stats.pj}</td>
            <td>${stats.dg}</td>
            <td>${stats.pg}</td>
            <td>${stats.pe}</td>
            <td>${stats.pp}</td>
          </tr>
        `).join("") +
      `</table>`;
  }

  function guardarEnHistorial() {
    const tabla = {};

    resultados.forEach(([g1, g2], i) => {
      if (g1 == null || g2 == null) return;
      const [a, b] = partidos[i];

      tabla[a] = tabla[a] || { pts: 0, pj: 0, dg: 0, pg: 0, pe: 0, pp: 0 };
      tabla[b] = tabla[b] || { pts: 0, pj: 0, dg: 0, pg: 0, pe: 0, pp: 0 };

      tabla[a].pj++;
      tabla[b].pj++;

      tabla[a].dg += g1 - g2;
      tabla[b].dg += g2 - g1;

      if (g1 > g2) {
        tabla[a].pts += 3;
        tabla[a].pg++;
        tabla[b].pp++;
      } else if (g2 > g1) {
        tabla[b].pts += 3;
        tabla[b].pg++;
        tabla[a].pp++;
      } else {
        tabla[a].pts += 1;
        tabla[b].pts += 1;
        tabla[a].pe++;
        tabla[b].pe++;
      }
    });

    const fecha = new Date().toLocaleString();
    const resumen = Object.entries(tabla)
      .sort((a, b) => b[1].pts - a[1].pts)
      .map(([nombre, s]) => `${nombre} ${s.pts}pts | PJ:${s.pj} DG:${s.dg} PG:${s.pg} PE:${s.pe} PP:${s.pp}`)
      .join('\n');

    const historial = JSON.parse(localStorage.getItem('ligas') || '[]');
    historial.push({ fecha, resumen });
    localStorage.setItem('ligas', JSON.stringify(historial));
    alert('Â¡Liga guardada en historial!');
  }

  window.onload = () => {
    const t = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', t);
  }
</script>